<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§  GÃ¶rev Ã‡Ã¶zme | SkillSculpt</title>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Varela Round', sans-serif; background: linear-gradient(to right, #2980b9, #6dd5fa); color: #333; padding: 30px; }
    h1, h2 { text-align: center; }
    .task-box { background-color: #fff; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    label, p { font-weight: bold; }
    input, textarea, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-top: 8px; }
    button { padding: 12px 25px; background-color: #002244; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: block; margin: 10px auto; }
    .timer-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 15px; align-items: center; }
    .timer-buttons button { background-color: #4CAF50; }
    .timer-buttons button#end-reading-btn { background-color: #f44336; display: none; }
    #timer-display { font-size: 1.5rem; font-weight: bold; color: #002244; min-width: 40px; text-align: center; }
    .quiz-question { margin-bottom: 15px; }
    .quiz-question .options label { font-weight: normal; }
  </style>
</head>
<body>
  <h1>ğŸ“š SkillSculpt GÃ¶revleri</h1>
  <form id="taskForm">
    <div class="task-box">
      <h2>ğŸ“– Okuma ParagrafÄ±</h2>
      <p>AÅŸaÄŸÄ±daki paragrafÄ± okumak iÃ§in "BaÅŸla" butonuna basÄ±n. BitirdiÄŸinizde "Bitirdim" butonuna basÄ±n:</p>
      <div id="reading-paragraph">
        Ali sabah erkenden uyandÄ±. GÃ¶zlerini ovuÅŸturdu ve pencereye koÅŸtu. Hava bulutluydu ama yaÄŸmur yaÄŸmÄ±yordu. BugÃ¼n okulda sunumu vardÄ±. HeyecanlÄ±ydÄ± Ã§Ã¼nkÃ¼ Ã§ok Ã§alÄ±ÅŸmÄ±ÅŸtÄ±. KahvaltÄ±da annesi ona yumurta ve peynir hazÄ±rladÄ±. Ali yemeÄŸini bitirdi, diÅŸlerini fÄ±rÃ§aladÄ± ve Ã§antasÄ±nÄ± alarak kapÄ±ya yÃ¶neldi. Okula vardÄ±ÄŸÄ±nda Ã¶ÄŸretmeni onu gÃ¼lÃ¼mseyerek karÅŸÄ±ladÄ±. SÄ±rasÄ± geldiÄŸinde tahtaya Ã§Ä±ktÄ± ve konuÅŸmaya baÅŸladÄ±. Ã–nce sesi titredi, ama sonra kendine gÃ¼veni geldi. Sunumunu bitirdiÄŸinde arkadaÅŸlarÄ± onu alkÄ±ÅŸladÄ±.
      </div>
      <div class="timer-buttons">
        <span id="timer-display">0s</span>
        <button type="button" id="start-reading-btn">â–¶ï¸ Okumaya BaÅŸla</button>
        <button type="button" id="end-reading-btn">â¹ï¸ OkumayÄ± Bitirdim</button>
      </div>
    </div>
    <div class="task-box">
      <h2>ğŸ”¤ Harf SÄ±ralama</h2>
      <label>Bu harfleri alfabetik sÄ±raya koyun: R, A, L, K, D</label>
      <input type="text" name="letter_order" placeholder="Ã–rn: A, D, K, L, R" required>
    </div>
    <div class="task-box">
      <h2>âœï¸ CÃ¼mle Kurma</h2>
      <label>Kelime grubu: kitap - Ali - okuyor</label>
      <input type="text" name="sentence" placeholder="CÃ¼mleyi yazÄ±n" required>
    </div>
    <div class="task-box">
      <h2>â“ Anlam Sorusu</h2>
      <label>Soru: DÃ¼nya kendi etrafÄ±nda kaÃ§ saatte dÃ¶ner?</label>
      <select name="quiz_answer" required>
        <option value="">SeÃ§iniz</option>
        <option value="12">12 saat</option>
        <option value="24">24 saat</option>
        <option value="48">48 saat</option>
      </select>
    </div>
    <div class="task-box">
      <h2>ğŸ§  Test SorularÄ±</h2>
      <div id="quiz-container">
        <p>Sorular yÃ¼kleniyor...</p>
      </div>
    </div>
    <div class="task-box">
      <h2>ğŸ“ YazÄ±m Testi</h2>
      <label>"gelecek", "okul", "arkadaÅŸlÄ±k" kelimelerini iÃ§eren bir paragraf yazÄ±n:</label>
      <textarea name="spelling_test" rows="5" required></textarea>
    </div>
    <button type="submit">âœ… GÃ¶revleri Tamamla</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const pageStartTime = performance.now();
      let readingStartTime = 0;
      let readingEndTime = 0;
      let timerInterval = null;
      let quizQuestions = [];

      const timerDisplay = document.getElementById('timer-display');
      const startBtn = document.getElementById('start-reading-btn');
      const endBtn = document.getElementById('end-reading-btn');
      const taskForm = document.getElementById('taskForm');
      const quizContainer = document.getElementById('quiz-container');

      function startReading() {
        clearInterval(timerInterval);
        readingStartTime = performance.now();
        startBtn.style.display = 'none';
        endBtn.style.display = 'block';
        let seconds = 0;
        timerDisplay.textContent = `${seconds}s`;
        timerInterval = setInterval(() => {
          seconds++;
          timerDisplay.textContent = `${seconds}s`;
        }, 1000);
      }

      function endReading() {
        readingEndTime = performance.now();
        clearInterval(timerInterval);
        endBtn.style.display = 'none';
        startBtn.style.display = 'block';
      }

      function loadQuiz() {
        fetch("/quiz-questions")
          .then(res => res.json())
          .then(questions => {
            quizQuestions = questions;
            quizContainer.innerHTML = "";
            questions.forEach((q, index) => {
              const questionDiv = document.createElement("div");
              questionDiv.classList.add("quiz-question");
              let optionsHTML = q.options.map(opt =>
                `<label><input type="radio" name="question${index}" value="${opt}" required> ${opt}</label>`
              ).join('<br>');
              questionDiv.innerHTML = `<p>${index + 1}. ${q.question}</p><div class="options">${optionsHTML}</div>`;
              quizContainer.appendChild(questionDiv);
            });
          })
          .catch(err => {
            console.error("Quiz yÃ¼klenemedi:", err);
            quizContainer.innerHTML = "<p>Test sorularÄ± yÃ¼klenirken bir hata oluÅŸtu.</p>";
          });
      }
      
      startBtn.addEventListener('click', startReading);
      endBtn.addEventListener('click', endReading);

      taskForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (readingStartTime === 0 || readingEndTime === 0) {
          alert("LÃ¼tfen okuma gÃ¶revini baÅŸlatÄ±p bitirin.");
          return;
        }

        const formData = new FormData(taskForm);
        const formEndTime = performance.now();
        const taskCompletionTime = Math.round((formEndTime - pageStartTime) / 1000);
        const readingTime = Math.round((readingEndTime - readingStartTime) / 1000);
        
        const correctOrder = "ADKLR"; 
        const userAnswerOrder = (formData.get("letter_order") || "").replace(/[\s,.-]/g, "").toUpperCase();
        const sequencingMistake = userAnswerOrder === correctOrder ? 0 : 1;
        
        let totalSemanticMistakes = 0;
        if (formData.get("quiz_answer") !== "24") {
            totalSemanticMistakes++;
        }
        quizQuestions.forEach((q, index) => {
            if (formData.get(`question${index}`) !== q.answer) {
                totalSemanticMistakes++;
            }
        });

        const spellingText = formData.get("spelling_test") || "";
        const blankRatio = [...formData.values()].filter(v => !v.trim()).length / (5 + quizQuestions.length);
        const spellingMistakes = (spellingText.match(/(?:gelecek|okul|arkadaÅŸlÄ±k)/gi) || []).length;
        const wrongSpellingRatio = spellingText.length ? 1 - (spellingMistakes / 3) : 1;

        const result = {
          age: 10,
          reading_time: readingTime,
          sequencing_difficulty_score: sequencingMistake,
          task_completion_time: taskCompletionTime,
          blank_answer_ratio: blankRatio,
          semantic_mistake_count: totalSemanticMistakes,
          wrong_spelling_ratio: wrongSpellingRatio,
        };

        try {
          const response = await fetch("/analyze-task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(result)
          });
          if (response.ok) {
            const data = await response.json();
            sessionStorage.setItem('analysisResult', JSON.stringify(data));
            window.location.href = '/analyze';
          } else {
            alert("Sunucu hatasÄ± oluÅŸtu.");
          }
        } catch (error) {
          console.error("Hata:", error);
          alert("Veri gÃ¶nderilemedi.");
        }
      });
      
      loadQuiz();
    });
  </script>
</body>
</html>